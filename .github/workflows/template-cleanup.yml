name: Template Cleanup (Fork)

# This workflow automatically cleans up template-specific files when the repository is forked.
# It removes Claude code review files that are only needed for the original repository.

on:
  push:
    branches: [main, master]
  workflow_dispatch: # Allow manual trigger for testing

permissions:
  contents: write

jobs:
  cleanup:
    name: Clean up fork
    runs-on: ubuntu-latest

    # Only run if this is a fork AND the cleanup target files still exist
    if: github.event.repository.fork == true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Check if cleanup is needed
        id: check
        run: |
          if [ -f ".github/workflows/claude-review.yml" ] || [ -f "scripts/claude-pr-review.ts" ]; then
            echo "needed=true" >> $GITHUB_OUTPUT
            echo "Cleanup is needed - found files to remove"
          else
            echo "needed=false" >> $GITHUB_OUTPUT
            echo "Cleanup already done or not needed"
          fi

      - name: Remove Claude review files
        if: steps.check.outputs.needed == 'true'
        run: |
          echo "Removing Claude code review files..."

          # Remove Claude review workflow
          if [ -f ".github/workflows/claude-review.yml" ]; then
            rm -f .github/workflows/claude-review.yml
            echo "Removed: .github/workflows/claude-review.yml"
          fi

          # Remove Claude review script
          if [ -f "scripts/claude-pr-review.ts" ]; then
            rm -f scripts/claude-pr-review.ts
            echo "Removed: scripts/claude-pr-review.ts"
          fi

          # Remove scripts directory if empty
          if [ -d "scripts" ] && [ -z "$(ls -A scripts)" ]; then
            rmdir scripts
            echo "Removed: empty scripts/ directory"
          fi

      - name: Clean up package.json dependencies
        if: steps.check.outputs.needed == 'true'
        run: |
          echo "Removing review-related devDependencies from package.json..."

          # Use Node.js to safely modify package.json
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));

            const depsToRemove = ['@anthropic-ai/sdk', '@octokit/rest'];
            let removed = [];

            if (pkg.devDependencies) {
              depsToRemove.forEach(dep => {
                if (pkg.devDependencies[dep]) {
                  delete pkg.devDependencies[dep];
                  removed.push(dep);
                }
              });
            }

            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
            console.log('Removed dependencies:', removed.join(', ') || 'none');
          "

      - name: Commit and push changes
        if: steps.check.outputs.needed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: clean up template files for fork

          This automated commit removes files that are specific to the original
          template repository and not needed for forks:

          - Removed Claude PR review workflow
          - Removed Claude PR review script
          - Removed related devDependencies (@anthropic-ai/sdk, @octokit/rest)

          Your starter kit is now ready to use!"

            git push
            echo "Changes committed and pushed successfully"
          fi

      - name: Self-destruct (remove this workflow)
        if: steps.check.outputs.needed == 'true'
        run: |
          echo "Removing template-cleanup workflow (self-destruct)..."

          rm -f .github/workflows/template-cleanup.yml

          git add -A
          git commit -m "chore: remove template-cleanup workflow

          The fork cleanup is complete. This workflow is no longer needed."

          git push
          echo "Template cleanup workflow removed successfully"
